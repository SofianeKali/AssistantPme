# IzyInbox - Assistant Administratif Intelligent pour PME

## Overview
IzyInbox is an intelligent web application designed to automate administrative tasks for SMEs. It leverages AI for email analysis and automates the management of quotes, invoices, appointments, and documents. The core purpose is to streamline administrative workflows, enhance efficiency, and provide actionable insights for small and medium-sized businesses. The project aims to become a leading solution for smart automation for busy managers, with ambitions for broad market adoption.

## User Preferences
I prefer detailed explanations.
I want to be asked before major changes are made to the codebase.
I like an iterative development approach.
I want the agent to prioritize robust error handling and logging.
I prefer to see a clear plan before implementation.

## System Architecture
The application uses a modern web stack:
- **Frontend**: React, TypeScript, Tailwind CSS, and Shadcn UI provide a responsive and aesthetically pleasing user interface. The design system incorporates a professional blue color scheme, Inter typography for UI, and JetBrains Mono for code/data, supporting both dark and light modes. Visual icon and color pickers enhance UX for category management. Sidebar menus include real-time count badges.
- **Backend**: Express.js with Node.js provides a robust API layer for business logic and data handling. Password encryption for email accounts uses AES-256-GCM with automatic migration of plaintext passwords.
- **Database**: PostgreSQL, hosted on Neon, for persistent storage of all application data.
- **AI Integration**: OpenAI's GPT-5 is central to intelligent email analysis, response generation, appointment suggestions, and natural language rule creation for custom alerts, including AI-powered email search.
- **Authentication**: A dual authentication system supports Replit Auth (OpenID Connect) for administrators and direct Replit users, and Email/Password for invited users.
- **Document Storage**: Per-user cloud storage with support for Google Drive and OneDrive. Each user can configure their own OAuth credentials for secure and isolated document storage. The system supports automatic categorization into a hierarchical folder structure. Credentials are encrypted using AES-256-GCM and stored securely per user.
- **UI/UX Decisions**: Consistent display of category icons and colors across the application (Dashboard, Settings, Email Badges). Dynamic displays for task statuses in the dashboard. Responsive chart period controls with vertical layout on mobile and horizontal layout on desktop. Alert cards feature hover effects and cursor-pointer to indicate clickability. Calendar views support Day, Week, and Month modes with adaptive navigation.
- **System Design Choices**: Global category system with flexible assignment to multiple email accounts via a junction table. Category deletion automatically transfers affected emails to a fallback "autre" category. Email read/unread status is tracked independently of processed status. Tasks associated with an email are automatically completed when the email is marked as "traité". Task assignment to users is supported. Appointment selection dialog for days with multiple appointments. Automated scanning of individual email accounts with configurable frequency and retention.
- **Multi-Tenancy & Security**: The system implements strict company-level data isolation enforced at the database schema level. All core entities (users, email_accounts, categories, settings, tasks, appointments, alerts, alert_rules, emails) include a `companyId` foreign key. **Status (2025-10-31 - FULLY SECURED + REGRESSION TESTED)**: ✅ All cross-tenant vulnerabilities **completely mitigated and validated**. User-facing endpoints fully secured with companyId filtering. All dashboard/stats queries use direct `emails.companyId` filtering (removed fragile LEFT JOINs). Background services (`alertService.ts`, `reminderService.ts`) iterate per company via `getAllCompanies()` and pass companyId to all storage calls with per-tenant try-catch isolation. `getAllEmails()` and `getEmailsCount()` enforce companyId requirement at both type-level AND runtime (throws error if omitted). **Sidebar Counts (getSidebarCounts)**: Fixed critical multi-tenant vulnerability where badge counts aggregated data across ALL companies instead of filtering by companyId - all 6 metrics (unprocessedEmails, unresolvedAlerts, tasksNew, tasksInProgress, upcomingAppointments, documentsInUnprocessedEmails) now enforce company isolation. **OIDC Auth (replitAuth.ts)**: Auto-creates companies for new OIDC users; gracefully handles email conflicts by reusing existing trial/subscription users to prevent duplicates. **Regression Testing**: E2E multi-tenant isolation test confirms zero cross-tenant data leakage (created 2 companies, 4 emails, multiple alerts - verified cross_tenant_leak=0 via JOIN queries on alerts→alert_emails→emails). Architect-validated complete tenant isolation across all layers with production-ready status.
- **Key Features**:
    - **Dashboard**: High-level overview with critical alerts, monthly statistics, activity summaries, and "Tasks in Progress" card with quick status changes. Features advanced data visualizations with configurable period controls, responsive grid layout, and full drag-and-drop customization with persistent user preferences.
    - **Email Management**: AI-powered categorization, priority/sentiment detection, auto-response generation, task assignment, and alerts. Supports bulk processing and individual email account scanning. Features read/unread status tracking and category-based automatic marking as processed. Includes AI-powered natural language search for emails. Attachment support for email replies.
    - **Calendar**: Monthly visualization and automated scheduling of appointments from emails, with AI-driven preparation, supporting Day, Week, and Month views.
    - **Document Management**: Automatic extraction, classification, and storage of email attachments on user-configured cloud storage (Google Drive or OneDrive) with full-text search, global toggles for extraction and provider selection, and comprehensive OAuth configuration documentation.
    - **Alert System**: Configurable custom alerts using natural language prompts interpreted by GPT-5. Supports bulk resolution of alerts.
    - **Configuration**: Comprehensive settings interface for system administration including Email Accounts (IMAP/SMTP, scan frequency, retention - admin-only), Categories (icons, colors, attachment redirection - admin-only), Cloud Storage (personal Google Drive/OneDrive OAuth configuration with step-by-step documentation), Automation (document extraction, storage provider, AI features - admin-only), and Alerts (custom alert rules). Admin-restricted features require admin role.
    - **User Management**: Role-based access control and task assignment.
    - **Advanced Features**: Sentiment analysis, KPIs, and automated reminders for quotes and invoices.
    - **Beta Lead Capture**: Professional landing page at `/beta` route with comprehensive lead capture form. Features react-hook-form + Zod validation, social proof elements, benefit cards, and ROI messaging targeting French SMBs. Captures prospect details (contact info, company size, role, pain points) for beta program recruitment.
    - **Subscription System**: Stripe-powered subscription management with 4 pricing tiers (Starter €59/month, Professional €149/month, Enterprise €399/month, Custom on-demand). Features include automated user onboarding, email welcome with temporary credentials via Resend, and **14-day free trial** option without requiring payment upfront. Trial users receive immediate access with admin privileges, trial expiration tracking via `trialEndsAt` field, and seamless conversion to paid plans. **Payment Flow (2025-10-31 - FULLY FIXED)**: ✅ Dual-path account provisioning system ensures reliable account creation after successful Stripe payments. Primary path uses `/api/stripe-webhook` for asynchronous processing; fallback path uses `/api/verify-payment` endpoint called automatically by PaymentSuccess page to handle dev environments where webhooks are unavailable. Idempotent design with `getUserByEmail` guard prevents duplicate account creation from simultaneous webhook + fallback invocations. Payment verification includes loading/error/success states with manual retry capability.

## External Dependencies
- **OpenAI**: GPT-5 model access for AI capabilities.
- **Google Drive**: Cloud storage for documents and email attachments (per-user OAuth configuration).
- **OneDrive**: Alternative cloud storage option via Microsoft Graph API (per-user OAuth configuration).
- **Replit Auth**: User authentication and authorization.
- **PostgreSQL (Neon)**: Primary relational database.
- **Tesseract.js**: Optical Character Recognition (OCR).
- **pdf-parse**: PDF text extraction.
- **imap-simple**: IMAP email scanning.
- **mailparser**: Email content parsing.
- **Nodemailer**: SMTP email sending.